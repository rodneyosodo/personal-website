<!doctype html><html dir=ltr lang=en data-theme class=html><head><title>Osodo Rodney
|
H2: IoT hardware for a 12-factor application</title><meta charset=utf-8><meta name=generator content="Hugo 0.109.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=author content="Osodo Rodney"><meta name=description content="
      Make no mistake sensors will drive the next-generation user experiences. We‚Äôve just got started with wearables.


    "><meta name=google-site-verification content="rodneyosodo.com"><link rel=stylesheet href=/scss/main.min.b2e0cb07595e3519ab1193bb421914e06c0e26b0cc561fef23b3c6131d4d2ffa.css integrity="sha256-suDLB1leNRmrEZO7QhkU4GwOJrDMVh/vI7PGEx1NL/o=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.b1c4e6a10bdbab01f33fff9d78816ee68cf9a9a731f07668afd546a79924cb80.css integrity="sha256-scTmoQvbqwHzP/+deIFu5oz5qacx8HZor9VGp5kky4A=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/solid.min.423dee17c62f55fa733a4ee13e00d523dfce88cc4f4ab4549a24ba36bd9de681.css integrity="sha256-Qj3uF8YvVfpzOk7hPgDVI9/OiMxPSrRUmiS6Nr2d5oE=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/brands.min.b7d54133b27e5b4de15245b8e143de3e8ed2d674c706137274cedc9953f31917.css integrity="sha256-t9VBM7J+W03hUkW44UPePo7S1nTHBhNydM7cmVPzGRc=" crossorigin=anonymous type=text/css><link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=canonical href=https://rodneyosodo.com/blogs/@rodneyosodo/h2-iot-hardware-for-a-12-factor-application-48b6d16eff17/><script type=text/javascript src=/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js integrity="sha256-+RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/anatole-theme-switcher.min.738c0e3a493854876aeab9e2316fd43f1936aeeac4cc6b3e60bb26456dba72ad.js integrity="sha256-c4wOOkk4VIdq6rniMW/UPxk2rurEzGs+YLsmRW26cq0=" crossorigin=anonymous></script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rodneyosodo.com/images/site-feature-image.png"><meta name=twitter:title content="H2: IoT hardware for a 12-factor application"><meta name=twitter:description content="Make no mistake sensors will drive the next-generation user experiences. We‚Äôve just got started with wearables."><meta property="og:title" content="H2: IoT hardware for a 12-factor application"><meta property="og:description" content="Make no mistake sensors will drive the next-generation user experiences. We‚Äôve just got started with wearables."><meta property="og:type" content="article"><meta property="og:url" content="https://rodneyosodo.com/blogs/@rodneyosodo/h2-iot-hardware-for-a-12-factor-application-48b6d16eff17/"><meta property="og:image" content="https://rodneyosodo.com/images/site-feature-image.png"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2021-10-15T18:53:59+00:00"><meta property="article:modified_time" content="2021-10-15T18:53:59+00:00"><meta property="og:site_name" content="Rodney Osodo"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"blogs","name":"H2: IoT hardware for a 12-factor application","headline":"H2: IoT hardware for a 12-factor application","alternativeHeadline":"","description":"
      Make no mistake sensors will drive the next-generation user experiences. We‚Äôve just got started with wearables.


    ","inLanguage":"en","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/rodneyosodo.com\/blogs\/@rodneyosodo\/h2-iot-hardware-for-a-12-factor-application-48b6d16eff17\/"},"author":{"@type":"Person","name":"Osodo Rodney"},"creator":{"@type":"Person","name":"Osodo Rodney"},"accountablePerson":{"@type":"Person","name":"Osodo Rodney"},"copyrightHolder":{"@type":"Person","name":"Osodo Rodney"},"copyrightYear":"2021","dateCreated":"2021-10-15T18:53:59.63Z","datePublished":"2021-10-15T18:53:59.63Z","dateModified":"2021-10-15T18:53:59.63Z","publisher":{"@type":"Organization","name":"Osodo Rodney","url":"https://rodneyosodo.com","logo":{"@type":"ImageObject","url":"https:\/\/rodneyosodo.com\/favicons\/favicon-32x32.png","width":"32","height":"32"}},"image":["https://rodneyosodo.com/images/site-feature-image.png"],"url":"https:\/\/rodneyosodo.com\/blogs\/@rodneyosodo\/h2-iot-hardware-for-a-12-factor-application-48b6d16eff17\/","wordCount":"2341","genre":[],"keywords":[]}</script></head><body class="body theme--light"><div class=wrapper><aside class=wrapper__sidebar><div class="sidebar
animated fadeInDown"><div class=sidebar__content><div class=sidebar__introduction><img class=sidebar__introduction-profileimage src=/images/profile.png alt="profile picture"><div class=sidebar__introduction-title><a href=/>Rodney Osodo</a></div><div class=sidebar__introduction-description><p>This is Rodney Osodo's website</p></div></div><ul class=sidebar__list><li class=sidebar__list-item><a href=https://www.linkedin.com/in/rodneyosodo rel=me aria-label=Linkedin title=Linkedin><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://github.com/rodneyosodo rel=me aria-label=GitHub title=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://gitlab.com/0x6f736f646f rel=me aria-label=Gitlab title=Gitlab><i class="fab fa-gitlab fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://twitter.com/b1ackd0t rel=me aria-label=Twitter title=Twitter><i class="fab fa-twitter fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://www.instagram.com/rodneyosodo/ rel=me aria-label=Instagram title=Instagram><i class="fab fa-instagram fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://www.tiktok.com/@b1ackd0t rel=me aria-label=TikTok title=TikTok><i class="fab fa-tiktok fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://www.youtube.com/@rodneyosodo rel=me aria-label=Youtube title=Youtube><i class="fab fa-youtube fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://stackoverflow.com/users/9017060/black-dot rel=me aria-label=StackOverflow title=StackOverflow><i class="fab fa-stack-overflow fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://rodneyosodo.medium.com/ rel=me aria-label=Medium title=Medium><i class="fab fa-medium fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://open.spotify.com/show/2MBoVx1mlX0kjHVrooqasf rel=me aria-label=Spotify title=Spotify><i class="fab fa-spotify fa-2x" aria-hidden=true></i></a></li></ul></div><footer class="footer footer__sidebar"><ul class=footer__list><li class=footer__item>&copy;
2020-2023</li><li class=footer__item><a class=link href=/imprint/ title>imprint</a></li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity=sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN crossorigin=anonymous></script>
<script type=text/x-mathjax-config>
      MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script></div></aside><main class=wrapper__main><header class=header><div class="animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span></a><nav class=nav><ul class=nav__list id=navMenu><li class=nav__list-item><a href=/ title>Home</a></li><li class=nav__list-item><a href=/blogs/ title>Blogs</a></li><li class=nav__list-item><a href=/portfolio/ title>Portfolio</a></li><li class=nav__list-item><a href=/publications/ title>Publications</a></li><li class=nav__list-item><a href=/talks/ title>Talks</a></li><li class=nav__list-item><div class=optionswitch><input class=optionswitch__picker type=checkbox id=menuoptionpicker hidden>
<label class=optionswitch__label class=optionswitch__label for=menuoptionpicker>Accomplishments <i class="fa fa-angle-down" aria-hidden=true></i></label><div class=optionswitch__triangle></div><ul class=optionswitch__list><li class=optionswitch__list-item><a href=/awards/ title>Awards</a></li><li class=optionswitch__list-item><a href=/certifications/ title>Certifications</a></li></ul></div></li><li class=nav__list-item><a href=/contact/ title>Contact</a></li></ul><ul class="nav__list nav__list--end"><li class=nav__list-item><div class=themeswitch><a title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></li></ul></nav></div></header><div class="post
animated fadeInDown"><div class=post__content><h1>H2: IoT Hardware for a 12-Factor Application</h1><blockquote><p>Make no mistake sensors will drive the next-generation user experiences. We‚Äôve just got started with wearables.</p></blockquote><blockquote><p>- Karthee Madasamy, MD, Qualcomm¬†Ventures</p></blockquote><blockquote><p><strong><em>The previous blog is at: ‚Äú</em></strong><a href=https://rodneyosodo.medium.com/h1-deciphering-the-12-factor-applications-style-bcab26790dcc><strong><em>H1:</em> Deciphering the 12 Factor Applications style</strong></a><strong><em>‚Äù</em></strong></p></blockquote><h3 id=introduction>Introduction</h3><p>The Internet of Things (IoT) is a term that refers to the network of devices that connect to each other via the internet. It involves connecting commonplace items or things to the internet via sensors and IP addresses. Anything from your shoes to your automobile to your coffee pot may be considered an everyday object. Connecting these gadgets to the internet allows data and user analytics to be extracted. The data and analytics gathered may be utilised for a variety of purposes, including surveys, automation, alerts, and just improving user experiences.</p><p>This project is primarily a hardware device with a hint of IoT. We have two systems: a frontend system, which will be our hardware device, and a backend system which will be our server. Our IoT setup will constitute an in-house JKUAT SES development board which is based on the ESP32 WROOM chips(i.e Any ESP32 chip can therefore be used as an alternative) and a DHT11 module as our temperature and humidity sensor. With this, we can send temperature and humidity data to our backend services for monitoring purposes.</p><p>For connectivity, the ESP32 chip has an in-built WIFI module that allows us to go into production by deploying the device to homes given that most homes have WIFI installed.</p><h3 id=project-stack-and-components>Project Stack and Components</h3><h4 id=jkuat-ses-development-board>JKUAT SES development board</h4><p>The schematic and the board layout of JKUAT SES development can be found <a href=https://github.com/JKUATSES/sesBoardv1>here</a>. In case you are using any other ESP32-based board, the following two schematics can be helpful.</p><h4 id=esp32-pinout>ESP32 pinout</h4><p><img src=/images/blogimages/0__TtUgMfEmOAsPscax.jpg alt>
<img src=/images/blogimages/0__eNHM6KgPBPHLZ7l3.png alt></p><h4 id=dht11>DHT11</h4><p>To detect water vapour, the electrical resistance between two electrodes is measured by the DHT11. A moisture-holding substrate with electrodes placed to the surface serves as the humidity sensor component. When water vapour is absorbed by the substrate, ions are released, increasing the conductivity between the electrodes. The relative humidity affects the change in resistance between the electrodes. The resistance between the electrodes reduces as the relative humidity rises, whereas the resistance rises as the relative humidity falls.</p><p>The DHT11 has a built-in thermistor that monitors temperature. The calibration coefficients are stored and controlled by an IC on the device.</p><h4 id=mqtt>MQTT</h4><p>The Internet of Things (IoT) has gone from zero to pervasive hype in a very short period. Message Queuing Telemetry Transport, or MQTT, is, I believe, one of the most critical elements affecting the condition of IoT today.</p><p>Message Queuing Telemetry Transport (MQTT) is a lightweight messaging protocol designed for usage in situations where clients require a minimal code footprint and are linked to unreliable networks or networks with restricted capacity. It‚Äôs mostly utilised for M2M (machine-to-machine) communication and Internet of Things connectivity.</p><p>MQTT was developed in 1999 by Dr Andy Stanford-Clark and Arlen Nipper. The communication method‚Äôs original aim was to allow monitoring equipment in the oil and gas sector to communicate data to remote servers.</p><p>MQTT uses a PUSH/SUBSCRIBE architecture to run on top of TCP/IP. There are two sorts of systems in MQTT architecture: clients and brokers. The server with which the clients communicate is known as a broker. Client messages are received by the broker, who then forwards them to other clients. Clients connect to the broker rather than communicating directly with one another.</p><p>When a client (known as a ‚Äúpublisher‚Äù) wants to spread information, it will publish to a specific topic, and the broker will then send that information to any customers (known as ‚Äúsubscribers‚Äù) that have subscribed to that subject.</p><p>Any client can be both a publisher and a subscriber. The clients are usually unaware of each other and are only aware of the broker who acts as an intermediary. The ‚Äúpub/sub model‚Äù is a popular term for this structure.</p><p>MQTT also reduces transmissions by using a well-defined, compact message structure. In comparison to HTTP, each message has a fixed header of only 2 bytes.</p><p><img src=/images/blogimages/0__Hy3WKVLqb__nF5nxK.jpg alt></p><h4 id=ota>OTA</h4><p>Instead of needing the user to connect the ESP32 to a computer via USB to execute the update, OTA programming allows the user to update/upload new software to the ESP32 via Wi-Fi.</p><p>When there is no physical access to the ESP module, the OTA capability comes in handy. It helps to cut down on the time spent upgrading each ESP module during maintenance.</p><p>One of the most useful features of OTA is that it allows a single central location to deliver an update to many ESPs on the same network.</p><p>The only drawback is that you must include an additional OTA code with each drawing you publish to use OTA in the next update.</p><p><img src=/images/blogimages/0__KuvBGMEkTWa25UrF.jpg alt></p><p><strong>Ways To Implement OTA In ESP32</strong><br>There are two ways to implement OTA functionality in ESP32.</p><p>1. Basic OTA‚Ää‚Äî‚ÄäOver-the-air updates are sent through Arduino IDE.<br>2. Web Updater OTA‚Ää‚Äî‚ÄäOver-the-air updates are sent through a web browser.</p><p>On an OTA architecture, there are two key components:<br>1. The remote device is in charge of checking for updates, downloading the new version, and installing it on its system.<br>2. The cloud server is in charge of creating, delivering, and managing updates to linked devices.</p><p>Security is key in IoT and we would need a way to verify that the binary file being downloaded is the correct file and not malware. This can be done by both systems, IoT devices and the Server. In this case, we use the server and ensure the communication is encrypted in between. This will reduce the IoT device work while sending the work to the server.</p><h4 id=circuit>Circuit</h4><p><img src=/images/blogimages/0__42ckkjas627NDRey.png alt></p><p>The DHT11 has the following connecting wires:<br>- GND is a common ground for both the dht11 and microcontroller.<br>- 5 V is a positive voltage that powers the dht11.<br>- Control transmit data</p><p>Wiring the DHT11 to the SES development board is easy:</p><p>1. Connect the VCC pin(Red wire) to the 5V on the SES development board.<br>2. Connect the GND pin(Black wire) to the ground.¬†<br>3. Connect the Data pin(Purple wire) to pin 15(i.e You can use any GPIO pins as the Data Pin)</p><h4 id=code>Code</h4><p><strong>Credentials</strong></p><p>Set the Wifi, and MQTT credentials to publish messages to the MQTT server.</p><p>#define WIFI_SSID your_wifi_ssid<br>#define WIFI_PASSWORD your_wifi_password<br>#define MQTT_SERVER your_mqtt_server_url<br>#define MQTT_USER your_mqtt_username<br>#define MQTT_PASS your_mqtt_password</p><h4 id=hardware-integration-code>Hardware integration code</h4><p>Libraries</p><p>Here we import the necessary libraries we will need for our project. Some of these libraries cannot be found in the default setup. If that is the case, you can install them in your setup by going to Sketch > Include Library > Manage Libraries and search for the library name as follows:</p><p>#include &lt;Arduino.h></p><p>#include &lt;DNSServer.h></p><p>#include &lt;WebServer.h></p><p>#include &lt;WiFi.h></p><p>#include &lt;HTTPClient.h></p><p>#include &lt;Update.h></p><p>#include &lt;WiFiManager.h></p><p>#include &lt;Arduino.h></p><p>#include &lt;Adafruit_Sensor.h></p><p>#include &lt;DHT.h></p><p>#include &lt;DHT_U.h></p><p>#include &ldquo;./config.h&rdquo; //contains our passwords</p><p>#include &lt;PubSubClient.h> //For publishing messages to the MQTT Server</p><p>#include &lt;ArduinoJson.h> //To create the payload so that we can publish it to the subscribed topics</p><p><strong>Declaration, definition and initialization</strong></p><p>Declare, and define variables and initialize classes.</p><p>#define CURRENT_VERSION &ldquo;1.0.0&rdquo; // The current version of the firmware running<br>#define DOWNLOAD_URL SERVER_URL // The server url where we will get the latest firmware version<br>#define DHTPIN 2 // Digital pin connected to the DHT sensor<br>#define DHTTYPE DHT11 // DHT 11<br>#define LED 4 // Digital pin connected to the inbuilt LED<br>#define ARDUINOJSON_USE_LONG_LONG 1<br>#define ARDUINOJSON_USE_DOUBLE 1<br>WiFiClient espClient; //Initializing the WiFiClient<br>void setup_wifi();<br>void reconnect();<br>PubSubClient client(espClient); // Initializing the PubSubClient<br>WebServer server(80); // Initializing the WebServer<br>// functions to take care of OTA firmware update<br>void handleRoot();<br>String getDownloadUrl();<br>bool downloadUpdate(String);<br>DHT_Unified dht(DHTPIN, DHTTYPE);<br>int ledState = LOW; // Set the ledstate to be off at the first instance<br>const long interval = 1000; // This is the interval we will be using to check for a new version<br>unsigned long previousMillis = 0; // previous timings in milliseconds<br>unsigned long currentMillis; // current timings in milliseconds<br>bool success; // download success</p><p><strong>setup function</strong></p><p>void setup() {<br>Serial.begin(115200); // begin Serial at 115200 baud rate<br>setup_wifi(); // function to setup up wifi<br>espClient.setServer(mqtt_server, 1883); //Setup the MQTT server</p><pre><code>// Initialize device.  
dht.begin();  
Serial.println(F(&quot;DHTxx Unified Sensor Example&quot;));  
// Print temperature sensor details.  
sensor\_t sensor;  
dht.temperature().getSensor( &amp; sensor);  
Serial.println(F(&quot; - - - - - - - - - - - - - - - - - - &quot;));  
Serial.println(F(&quot;Temperature Sensor Present&quot;));  

// Print humidity sensor details.dht.humidity().getSensor(&amp;sensor);  
Serial.println(F(&quot; - - - - - - - - - - - - - - - - - - &quot;));  
Serial.println(F(&quot;Humidity Sensor Present&quot;));  
Serial.setDebugOutput(true); // Set debug to true in order to print more serial output  
pinMode(LED, OUTPUT); // Initialize the inbuilt led as an output device  
delay(3000); // Set a delay of 3 seconds (optional)  
String version = String(&quot;&lt;p&gt;Current Version - v&quot;) + String(CURRENT\_VERSION) + String(&quot;&lt;/p&gt;&quot;);  
Serial.println(version);  
// Setup Wifi Manager  
WiFiManager wm;  
WiFiManagerParameter versionText(version.c\_str());  
wm.addParameter( &amp; versionText);  
if (!wm.autoConnect()) {  
    Serial.println(&quot;failed to connect and hit timeout&quot;);  
    ESP.restart();  
    delay(1000);  
}  
// Check if we need to download a new version  
String downloadUrl = getDownloadUrl();  
if (downloadUrl.length() &gt; 0) {  
    success = downloadUpdate(downloadUrl);  
    if (!success) {  
        Serial.println(&quot;Error updating device&quot;);  
    }  
}  
server.on(&quot;/&quot;, handleRoot);  
server.begin();  
Serial.println(&quot;HTTP server started&quot;);  
Serial.print(&quot;IP address: &quot;);  
Serial.println(WiFi.localIP());  
</code></pre><p>}</p><p><strong>Loop Function</strong></p><p>void loop() {<br>// Get temperature event and print its value.<br>sensors_event_t event;<br>dht.temperature().getEvent( & event);<br>if (isnan(event.temperature)) {<br>Serial.println(F(&ldquo;Error reading temperature!&rdquo;));<br>} else {<br>Serial.print(F(&ldquo;Temperature: &ldquo;));<br>Serial.print(event.temperature);<br>Serial.println(F(&ldquo;¬∞C&rdquo;));<br>}<br>// Get humidity event and print its value.<br>dht.humidity().getEvent( & event);<br>if (isnan(event.relative_humidity)) {<br>Serial.println(F(&ldquo;Error reading humidity!&rdquo;));<br>} else {<br>Serial.print(F(&ldquo;Humidity: &ldquo;));<br>Serial.print(event.relative_humidity);<br>Serial.println(F(&rdquo;%&rdquo;));<br>}<br>currentMillis = millis();<br>if (currentMillis - previousMillis >= interval) {<br>previousMillis = currentMillis;<br>ledState = ledState == LOW ? HIGH : LOW;<br>digitalWrite(4, ledState);<br>}<br>// Just chill<br>server.handleClient();<br>delay(1000);<br>char msg[200];<br>if (!espClient.connected()) {<br>reconnect();<br>}<br>StaticJsonBuffer &lt; 300 > JSONbuffer;<br>JsonObject & JSONencoder = JSONbuffer.createObject();<br>JSONencoder[&ldquo;time&rdquo;] = millis();<br>JSONencoder[&ldquo;temperature&rdquo;] = event.temperature;<br>JSONencoder[&ldquo;humidity&rdquo;] = event.relative_humidity;<br>char JSONmessageBuffer[100];<br>JSONencoder.printTo(JSONmessageBuffer, sizeof(JSONmessageBuffer));<br>Serial.println(JSONmessageBuffer);<br>if (espClient.publish(&ldquo;dht/user_id892&rdquo;, JSONmessageBuffer) == true) {<br>Serial.println(&ldquo;Success sending message&rdquo;);<br>} else {<br>Serial.println(&ldquo;Error sending message&rdquo;);<br>}<br>espClient.loop();<br>}</p><p><strong>Handle server requests</strong></p><p>void handleRoot() {<br>server.send(200, &ldquo;text/plain&rdquo;, &ldquo;v&rdquo; + String(CURRENT_VERSION));<br>}</p><p><strong>Get download link</strong></p><p>String getDownloadUrl() {<br>HTTPClient http;<br>String downloadUrl;<br>Serial.print(&rdquo;[HTTP] begin‚Ä¶\n&rdquo;);<br>String url = DOWNLOAD_URL;<br>http.begin(url);<br>Serial.print("[HTTP] GET‚Ä¶\n");<br>// start connection and send HTTP header<br>int httpCode = http.GET();<br>// httpCode will be negative on error<br>if (httpCode > 0) {<br>// HTTP header has been send and Server response header has been handled<br>Serial.printf("[HTTP] GET‚Ä¶ code: %d\n", httpCode);<br>// file found at server<br>if (httpCode == HTTP_CODE_OK) {<br>String payload = http.getString();<br>Serial.println(payload);<br>downloadUrl = payload;<br>} else {<br>Serial.println(&ldquo;Device is up to date!&rdquo;);<br>}<br>} else {<br>Serial.printf("[HTTP] GET‚Ä¶ failed, error: %s\n", http.errorToString(httpCode).c_str());<br>}<br>http.end();<br>Serial.println(downloadUrl);<br>return downloadUrl;<br>}</p><p><strong>Download binary firmware</strong></p><p>/*<br>Download binary image and use Update library to update the device.<br>*/<br>/*<br>Download binary image and use Update library to update the device.<br>*/<br>bool downloadUpdate(String url) {<br>HTTPClient http;<br>Serial.print("[HTTP] Download begin‚Ä¶\n");<br>http.begin(url);<br>Serial.print("[HTTP] GET‚Ä¶\n");<br>// start connection and send HTTP header<br>int httpCode = http.GET();<br>if (httpCode > 0) {<br>// HTTP header has been send and Server response header has been handled<br>Serial.printf("[HTTP] GET‚Ä¶ code: %d\n", httpCode);<br>// file found at server<br>if (httpCode == HTTP_CODE_OK) {<br>int contentLength = http.getSize();<br>Serial.println(&ldquo;contentLength : " + String(contentLength));<br>if (contentLength > 0) {<br>bool canBegin = Update.begin(contentLength);<br>if (canBegin) {<br>WiFiClient stream = http.getStream();<br>Serial.println(&ldquo;Begin OTA. This may take 2‚Äì5 mins to complete. Things might be quite for a while.. Patience!&rdquo;);<br>size_t written = Update.writeStream(stream);<br>if (written == contentLength) {<br>Serial.println(&ldquo;Written : " + String(written) + " successfully&rdquo;);<br>} else {<br>Serial.println(&ldquo;Written only : " + String(written) + &ldquo;/&rdquo; + String(contentLength) + &ldquo;. Retry?&rdquo;);<br>}<br>if (Update.end()) {<br>Serial.println(&ldquo;OTA done!&rdquo;);<br>if (Update.isFinished()) {<br>Serial.println(&ldquo;Update successfully completed. Rebooting.&rdquo;);<br>ESP.restart();<br>return true;<br>} else {<br>Serial.println(&ldquo;Update not finished? Something went wrong!&rdquo;);<br>return false;<br>}<br>} else {<br>Serial.println(&ldquo;Error Occurred. Error #: " + String(Update.getError()));<br>return false;<br>}<br>} else {<br>Serial.println(&ldquo;Not enough space to begin OTA&rdquo;);<br>client.flush();<br>return false;<br>}<br>} else {<br>Serial.println(&ldquo;There was no content in the response&rdquo;);<br>client.flush();<br>return false;<br>}<br>} else {<br>return false;<br>}<br>} else {<br>return false;<br>}<br>}</p><p><strong>Setup WIFI function</strong></p><p>void setup_wifi() {<br>// Connecting to a WiFi network<br>WiFi.begin(ssid, password);<br>while (WiFi.status() != WL_CONNECTED) {<br>delay(500);<br>Serial.print(&rdquo;.&rdquo;);<br>}<br>Serial.println(&ldquo;WiFi connected&rdquo;);<br>Serial.println(&ldquo;IP address: &ldquo;);<br>Serial.println(WiFi.localIP());<br>}</p><p><strong>Reconnect function</strong></p><p>void reconnect() {<br>// Loop until we&rsquo;re reconnected<br>Serial.println(&ldquo;In reconnect‚Ä¶&rdquo;);<br>while (!espClient.connected()) {<br>Serial.print(&ldquo;Attempting MQTT connection‚Ä¶&rdquo;);<br>// Attempt to connect<br>if (espClient.connect(&ldquo;SES_DHT&rdquo;, MQTT_USER, MQTT_PASS)) {<br>Serial.println(&ldquo;connected&rdquo;);<br>} else {<br>Serial.print(&ldquo;failed, rc=&rdquo;);<br>Serial.print(espClient.state());<br>Serial.println(&rdquo; try again in 5 seconds&rdquo;);<br>delay(5000);<br>}<br>}<br>}</p><p><strong>Subscription</strong></p><p>How you handle the reception of data all depends on your level of expertise. One could set up a decoy MQTT server in their local station device¬†<br>and tap into the data from the open port for their own application or just simply:</p><p><strong>Configure HiveMQ browser client to visualize the data in the browser</strong></p><p>Procedure:<br>1. Go to this [link](<a href=http://www.hivemq.com/demos/websocket-client/>http://www.hivemq.com/demos/websocket-client/</a>) and click on connect button.<br>2. Add the subscription topics one for each topic the ESP32 uses.</p><p>As soon as the ESP32 client start publishing data to the one topic in our code you should be able to see the changes in the page under the messages.</p><p><strong>Important</strong></p><p>The code provided above uses the Serial library for debugging purposes. The whole setup will only operate with the Serial port open.<br>For deployment, comment out all the Serial instances in the code above.</p><p>The whole code can be found <a href=https://github.com/JKUATSES/2021-project-hack/tree/main/Software>here</a></p><blockquote><p>As an IoT product there‚Äôs nothing like the excitement of getting the first version of the product out‚Ää‚Äî‚Ääit gives one that adrenaline pump.</p></blockquote><blockquote><p>- Bipin RR, VP Digital Services, Tata¬†Elxsi</p></blockquote><p>If you liked this article, click theüëè multiple times below so other people will see it here on Medium.</p><p>Let‚Äôs be friends on <a href=https://twitter.com/b1ackd0t>Twitter</a>. Happy Coding üòâ</p><h3 id=acknowledgements>Acknowledgements</h3><p>1. <a href=https://twitter.com/GituKelvin/>Kelvin Gitu</a><br>2. <a href=https://github.com/WashingtonKK/>Washington Kamadi</a><br>3. <a href=https://twitter.com/MwadimeCalvin>Calvin Mwadime</a></p><h3 id=references>References</h3><p>1. <a href=https://blackd0t.gitbook.io/africastalking-eris-devkit-playground/arduino/dht11>https://blackd0t.gitbook.io/africastalking-eris-devkit-playground/arduino/dht11</a><br>2. <a href=https://lastminuteengineers.com/esp32-ota-web-updater-arduino-ide/>https://lastminuteengineers.com/esp32-ota-web-updater-arduino-ide/</a><br>3. <a href=https://microcontrollerslab.com/esp32-ota-over-the-air-updates-asyncelegantota-library-arduino/>https://microcontrollerslab.com/esp32-ota-over-the-air-updates-asyncelegantota-library-arduino/</a><br>4. <a href=https://www.survivingwithandroid.com/esp32-mqtt-client-publish-and-subscribe/>https://www.survivingwithandroid.com/esp32-mqtt-client-publish-and-subscribe/</a><br>5. <a href=https://www.allacronyms.com/MQTT/Message_Queuing_Telemetry_Transport>https://www.allacronyms.com/MQTT/Message_Queuing_Telemetry_Transport</a><br>6. <a href=https://horasvilla.com/iot-and-iiot-what-is-the-difference-between-them/>https://horasvilla.com/iot-and-iiot-what-is-the-difference-between-them/</a></p><h4 id=next-blog-series-h3-first-half-of-the-12-factor-apphttpsrodneyosodomediumcomh3-first-half-of-the-12-factor-app-32f2783e29b1>NEXT BLOG SERIES: <a href=https://rodneyosodo.medium.com/h3-first-half-of-the-12-factor-app-32f2783e29b1>H3: First half of the 12-factor app</a></h4></div><div class=post__footer></div></div></main></div><footer class="footer footer__base"><ul class=footer__list><li class=footer__item>&copy;
2020-2023</li><li class=footer__item><a class=link href=/imprint/ title>imprint</a></li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity=sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN crossorigin=anonymous></script>
<script type=text/x-mathjax-config>
      MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script></body></html>