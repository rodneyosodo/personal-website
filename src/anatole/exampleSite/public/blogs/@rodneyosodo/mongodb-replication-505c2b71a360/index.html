<!doctype html><html dir=ltr lang=en data-theme class=html><head><title>Osodo Rodney
|
Mongodb REPLICATION</title><meta charset=utf-8><meta name=generator content="Hugo 0.111.3"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=author content="Osodo Rodney"><meta name=description content="
      Disclaimer


    "><meta name=google-site-verification content="rodneyosodo.com"><link rel=stylesheet href=/scss/main.min.b2e0cb07595e3519ab1193bb421914e06c0e26b0cc561fef23b3c6131d4d2ffa.css integrity="sha256-suDLB1leNRmrEZO7QhkU4GwOJrDMVh/vI7PGEx1NL/o=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.b1c4e6a10bdbab01f33fff9d78816ee68cf9a9a731f07668afd546a79924cb80.css integrity="sha256-scTmoQvbqwHzP/+deIFu5oz5qacx8HZor9VGp5kky4A=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/solid.min.423dee17c62f55fa733a4ee13e00d523dfce88cc4f4ab4549a24ba36bd9de681.css integrity="sha256-Qj3uF8YvVfpzOk7hPgDVI9/OiMxPSrRUmiS6Nr2d5oE=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/brands.min.b7d54133b27e5b4de15245b8e143de3e8ed2d674c706137274cedc9953f31917.css integrity="sha256-t9VBM7J+W03hUkW44UPePo7S1nTHBhNydM7cmVPzGRc=" crossorigin=anonymous type=text/css><link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=canonical href=https://rodneyosodo.com/blogs/@rodneyosodo/mongodb-replication-505c2b71a360/><script type=text/javascript src=/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js integrity="sha256-+RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/anatole-theme-switcher.min.738c0e3a493854876aeab9e2316fd43f1936aeeac4cc6b3e60bb26456dba72ad.js integrity="sha256-c4wOOkk4VIdq6rniMW/UPxk2rurEzGs+YLsmRW26cq0=" crossorigin=anonymous></script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rodneyosodo.com/images/site-feature-image.png"><meta name=twitter:title content="Mongodb REPLICATION"><meta name=twitter:description content="Disclaimer"><meta property="og:title" content="Mongodb REPLICATION"><meta property="og:description" content="Disclaimer"><meta property="og:type" content="article"><meta property="og:url" content="https://rodneyosodo.com/blogs/@rodneyosodo/mongodb-replication-505c2b71a360/"><meta property="og:image" content="https://rodneyosodo.com/images/site-feature-image.png"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2020-03-03T01:33:27+00:00"><meta property="article:modified_time" content="2020-03-03T01:33:27+00:00"><meta property="og:site_name" content="Rodney Osodo"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"blogs","name":"Mongodb REPLICATION","headline":"Mongodb REPLICATION","alternativeHeadline":"","description":"
      Disclaimer


    ","inLanguage":"en","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/rodneyosodo.com\/blogs\/@rodneyosodo\/mongodb-replication-505c2b71a360\/"},"author":{"@type":"Person","name":"Osodo Rodney"},"creator":{"@type":"Person","name":"Osodo Rodney"},"accountablePerson":{"@type":"Person","name":"Osodo Rodney"},"copyrightHolder":{"@type":"Person","name":"Osodo Rodney"},"copyrightYear":"2020","dateCreated":"2020-03-03T01:33:27.34Z","datePublished":"2020-03-03T01:33:27.34Z","dateModified":"2020-03-03T01:33:27.34Z","publisher":{"@type":"Organization","name":"Osodo Rodney","url":"https://rodneyosodo.com","logo":{"@type":"ImageObject","url":"https:\/\/rodneyosodo.com\/favicons\/favicon-32x32.png","width":"32","height":"32"}},"image":["https://rodneyosodo.com/images/site-feature-image.png"],"url":"https:\/\/rodneyosodo.com\/blogs\/@rodneyosodo\/mongodb-replication-505c2b71a360\/","wordCount":"830","genre":[],"keywords":[]}</script></head><body class="body theme--light"><div class=wrapper><aside class=wrapper__sidebar><div class="sidebar
animated fadeInDown"><div class=sidebar__content><div class=sidebar__introduction><img class=sidebar__introduction-profileimage src=/images/profile.png alt="profile picture"><div class=sidebar__introduction-title><a href=/>Rodney Osodo</a></div><div class=sidebar__introduction-description><p>This is Rodney Osodo's website</p></div></div><ul class=sidebar__list><li class=sidebar__list-item><a href=https://www.linkedin.com/in/rodneyosodo rel=me aria-label=Linkedin title=Linkedin><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://github.com/rodneyosodo rel=me aria-label=GitHub title=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://gitlab.com/0x6f736f646f rel=me aria-label=Gitlab title=Gitlab><i class="fab fa-gitlab fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://twitter.com/b1ackd0t rel=me aria-label=Twitter title=Twitter><i class="fab fa-twitter fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://www.instagram.com/rodneyosodo/ rel=me aria-label=Instagram title=Instagram><i class="fab fa-instagram fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://www.tiktok.com/@b1ackd0t rel=me aria-label=TikTok title=TikTok><i class="fab fa-tiktok fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://www.youtube.com/@rodneyosodo rel=me aria-label=Youtube title=Youtube><i class="fab fa-youtube fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://stackoverflow.com/users/9017060/black-dot rel=me aria-label=StackOverflow title=StackOverflow><i class="fab fa-stack-overflow fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://rodneyosodo.medium.com/ rel=me aria-label=Medium title=Medium><i class="fab fa-medium fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://open.spotify.com/show/2MBoVx1mlX0kjHVrooqasf rel=me aria-label=Spotify title=Spotify><i class="fab fa-spotify fa-2x" aria-hidden=true></i></a></li></ul></div><footer class="footer footer__sidebar"><ul class=footer__list><li class=footer__item>&copy;
2020-2023</li><li class=footer__item><a class=link href=/imprint/ title>imprint</a></li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity=sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN crossorigin=anonymous></script>
<script type=text/x-mathjax-config>
      MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script></div></aside><main class=wrapper__main><header class=header><div class="animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span></a><nav class=nav><ul class=nav__list id=navMenu><li class=nav__list-item><a href=/ title>Home</a></li><li class=nav__list-item><a href=/blogs/ title>Blogs</a></li><li class=nav__list-item><a href=/portfolio/ title>Portfolio</a></li><li class=nav__list-item><a href=/publications/ title>Publications</a></li><li class=nav__list-item><a href=/talks/ title>Talks</a></li><li class=nav__list-item><div class=optionswitch><input class=optionswitch__picker type=checkbox id=menuoptionpicker hidden>
<label class=optionswitch__label class=optionswitch__label for=menuoptionpicker>Accomplishments <i class="fa fa-angle-down" aria-hidden=true></i></label><div class=optionswitch__triangle></div><ul class=optionswitch__list><li class=optionswitch__list-item><a href=/awards/ title>Awards</a></li><li class=optionswitch__list-item><a href=/certifications/ title>Certifications</a></li></ul></div></li><li class=nav__list-item><a href=/contact/ title>Contact</a></li></ul><ul class="nav__list nav__list--end"><li class=nav__list-item><div class=themeswitch><a title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></li></ul></nav></div></header><div class="post
animated fadeInDown"><div class=post__content><h1>Mongodb REPLICATION</h1><h3 id=disclaimer>Disclaimer</h3><p><em>I donâ€™t know anything about what I wrote.ðŸ˜‰</em></p><p><img src=/images/blogimages/0__exB__r5MrNBvnDMCS.jpg alt></p><h3 id=what-is-database-replication>What is database replication</h3><p>It is a technique where an instance of a database is exactly copied to another location.</p><p>There are many types of database replication but for now we will look at physical replication. Physical replication alllows you to replicate the entire database cluster onto another server.</p><p>Synchronous replication creates copies of data in real time. As synchronous replication is continuously creating data in real time, it tends to be very expensive. However, it is also very reliable in the event of a disaster.<br>Synchronous replication requires capable computation capacity because it creates latency and slows the primary systems. It does this by using WAL to stay in sync. It replicates everything on the cluster.</p><p><img src=/images/blogimages/0__G2MZGmv7zplJiyaa.jpg alt></p><h3 id=advantages-of-replication>Advantages of Replication</h3><ul><li><strong>High Availability</strong>Â : when one node or the primary node goes down, another node in the cluster can be switched on and relied upon for serving the workload.</li><li><strong>Increased read performance</strong>Â : Multiple machines provide greater processing power and data can be spread across multiple machines on a network. This vastly improves your applicationâ€™s read performance.</li><li><strong>Greater scalability</strong>Â : As your user base grows and report complexity increases, your resources can grow.</li></ul><h3 id=lets-start>Lets start</h3><p><code>We shall do this by using docker.</code></p><ol><li>Creating a single database</li></ol><p><img src=/images/blogimages/1__4Qp7SODYfwQFkG__OrXfH2w.png alt></p><p>2. Now lets stop the docker then create another database using docker compose</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>version: &#39;3.0&#39;services: demo-mongo-worker-3:   image: &#39;mongo:latest&#39;   ports:     - &#39;27018:27017&#39;   restart: always
</span></span></code></pre></div><p>3. Then we run docker-compose up</p><p>4. We run docker-compose down to stop the mongodb container</p><p>5. Finally let us create a replica set</p><p>We create one primary node and three secondary nodes. If the primary node goes down the other nodes vote to elect a new primary node. Each node requires a data volume and also a shared volume for the nodes to communicate.</p><p>For this to work we need volumes and a single network of type bridge.</p><p><strong>For our services.</strong><br>We need a docker container to generate a new key every time the cluster is started. First we create an openssl image which will be responsible for creating our keyfile.</p><p>For the primary node we will mount the shared volume and its own volume. We also set its password and username with environment variables then map its port from 27017 to 2717 since I am running mongodb in my local machine.<br>For the secondary nodes we only change the port mapping, their names and volumes.</p><p>6. If we run this it should bring up the cluster.</p><p>Our compose file is here:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>version: &#39;3.0&#39;services: demo-mongo-keys:   image: openssl   build: openssl/.   volumes:     - &#39;demo-mongo-keys:/mongo-conf&#39;   command: bash -c &#34;openssl rand -base64 741 &gt; /mongo-conf/mongodb-keyfile; chmod 600 /mongo-conf/mongodb-keyfile; chown 999 /mongo-conf/mongodb-keyfile&#34;  demo-mongo-primary:   image: &#39;mongo:latest&#39;   volumes:     - &#39;demo-mongo-keys:/opt/keyfile&#39;     - &#39;demo-mongo-data-0:/data/db&#39;   env_file: ./mongod.env   ports:     - &#39;2717:27017&#39;   command: mongod --auth --keyFile /opt/keyfile/mongodb-keyfile --replSet demo-replica-set   depends_on:     - demo-mongo-keys   networks:     demo-replica-set: demo-mongo-worker-1:   image: &#39;mongo:latest&#39;   volumes:     - &#39;demo-mongo-keys:/opt/keyfile&#39;     - &#39;demo-mongo-data-1:/data/db&#39;   env_file: ./mongod.env   ports:     - &#39;27018:27017&#39;   command: mongod --auth --keyFile /opt/keyfile/mongodb-keyfile --replSet demo-replica-set   depends_on:     - demo-mongo-keys   networks:     demo-replica-set:  demo-mongo-worker-2:   image: &#39;mongo:latest&#39;   volumes:     - &#39;demo-mongo-keys:/opt/keyfile&#39;     - &#39;demo-mongo-data-2:/data/db&#39;   env_file: ./mongod.env   ports:     - &#39;27019:27017&#39;   command: mongod --auth --keyFile /opt/keyfile/mongodb-keyfile --replSet demo-replica-set   depends_on:     - demo-mongo-keys   networks:     demo-replica-set:  demo-mongo-worker-3:   image: &#39;mongo:latest&#39;   volumes:     - &#39;demo-mongo-keys:/opt/keyfile&#39;     - &#39;demo-mongo-data-3:/data/db&#39;   env_file: ./mongod.env   ports:     - &#39;27020:27017&#39;   command: mongod --auth --keyFile /opt/keyfile/mongodb-keyfile --replSet demo-replica-set   depends_on:     - demo-mongo-keys   networks:     demo-replica-set: volumes: demo-mongo-keys: demo-mongo-data-0: demo-mongo-data-1: demo-mongo-data-2: demo-mongo-data-3: networks: demo-replica-set:   driver: bridge   ipam:     driver: default     config:       - subnet: 172.10.99.0/24
</span></span></code></pre></div><p>7. We will login to the demo-mongo-primary node, define our replica set and then make it the new primary node by setting its priority high.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>docker-compose exec demo-mongo-primary mongo -u &#34;root&#34; -p &#34;password&#34;
</span></span></code></pre></div><p>8. Instatiate the replica set</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>rs.initiate(    {&#34;_id&#34; : &#34;tut12-replica-set&#34;,    &#34;members&#34; : [        {&#34;_id&#34; : 0,&#34;host&#34; : &#34;tut12-mongo-primary:27017&#34;},        {&#34;_id&#34; : 1,&#34;host&#34; : &#34;tut12-mongo-worker-1:27017&#34;},        {&#34;_id&#34; : 2,&#34;host&#34; : &#34;tut12-mongo-worker-2:27017&#34;},        {&#34;_id&#34; : 3,&#34;host&#34; : &#34;tut12-mongo-worker-3:27017&#34;}        ]    });
</span></span></code></pre></div><p>9. Set the priority of the master over the other nodes</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>conf = rs.config();
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>conf.members[0].priority = 2;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>rs.reconfig(conf);
</span></span></code></pre></div><p>10. Now lets add some data and check to set it.</p><p>11. We head over to <a href=https://www.json-generator.com/>json-generator</a> to generate json data to push to our mongodb</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[  &#39;{{repeat(10000)}}&#39;,  {    _id: &#39;{{objectId()}}&#39;,    index: &#39;{{index()}}&#39;,    guid: &#39;{{guid()}}&#39;,    isActive: &#39;{{bool()}}&#39;,    balance: &#39;{{floating(1000, 4000, 2, &#34;$0,0.00&#34;)}}&#39;,    picture: &#39;http://placehold.it/32x32&#39;,    age: &#39;{{integer(20, 40)}}&#39;,    eyeColor: &#39;{{random(&#34;blue&#34;, &#34;brown&#34;, &#34;green&#34;)}}&#39;,    name: &#39;{{firstName()}} {{surname()}}&#39;,    gender: &#39;{{gender()}}&#39;,    company: &#39;{{company().toUpperCase()}}&#39;,    email: &#39;{{email()}}&#39;,    phone: &#39;+1 {{phone()}}&#39;,    address: &#39;{{integer(100, 999)}} {{street()}}, {{city()}}, {{state()}}, {{integer(100, 10000)}}&#39;,    about: &#39;{{lorem(1, &#34;paragraphs&#34;)}}&#39;,    registered: &#39;{{date(new Date(2014, 0, 1), new Date(), &#34;YYYY-MM-ddThh:mm:ss Z&#34;)}}&#39;,    latitude: &#39;{{floating(-90.000001, 90)}}&#39;,    longitude: &#39;{{floating(-180.000001, 180)}}&#39;  }]
</span></span></code></pre></div><p>12. We will use the python script to push data to the database.<br>We finally run the bash file to push data.</p><p>13. Check the data base:</p><p><img src=/images/blogimages/1__4DYSTgJ1tGqmrF7__bYCfrQ.png alt></p><h3 id=considerations>Considerations</h3><p>This replica set consists of 3 nodes as you can see.However, if you decide to go with an even number say 4 members, deploy an arbiter so that the set has an odd number of voting members. Voting is usually conducted by cluster members to elect a primary node and so adding an arbiter ensures no ties arise during voting.</p><h3 id=references><strong>References</strong></h3><ol><li><a href=https://docs.mongodb.com/manual/tutorial/enforce-keyfile-access-control-in-existing-replica-set/>https://docs.mongodb.com/manual/tutorial/enforce-keyfile-access-control-in-existing-replica-set/</a></li><li><a href=https://github.com/rodneyosodo/mongodb_replicaset>https://github.com/rodneyosodo/mongodb_replicaset</a></li><li><a href="https://www.youtube.com/watch?v=-XzMfd4XQak&amp;t=1157s">https://www.youtube.com/watch?v=-XzMfd4XQak&amp;t=1157s</a></li><li><a href="https://www.youtube.com/watch?v=3wus5trgi0A">https://www.youtube.com/watch?v=3wus5trgi0A</a></li></ol></div><div class=post__footer></div></div></main></div><footer class="footer footer__base"><ul class=footer__list><li class=footer__item>&copy;
2020-2023</li><li class=footer__item><a class=link href=/imprint/ title>imprint</a></li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity=sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN crossorigin=anonymous></script>
<script type=text/x-mathjax-config>
      MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script></body></html>