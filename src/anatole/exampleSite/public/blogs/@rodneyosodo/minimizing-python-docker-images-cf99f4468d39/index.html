<!doctype html><html dir=ltr lang=en data-theme class=html><head><title>Osodo Rodney
|
Minimizing python docker images</title><meta charset=utf-8><meta name=generator content="Hugo 0.109.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=author content="Osodo Rodney"><meta name=description content="
      During the transition to a micro service based approach at Qualislabs I saw new faces joining my team. There was definitely a learning‚Ä¶


    "><meta name=google-site-verification content="rodneyosodo.com"><link rel=stylesheet href=/scss/main.min.b2e0cb07595e3519ab1193bb421914e06c0e26b0cc561fef23b3c6131d4d2ffa.css integrity="sha256-suDLB1leNRmrEZO7QhkU4GwOJrDMVh/vI7PGEx1NL/o=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.b1c4e6a10bdbab01f33fff9d78816ee68cf9a9a731f07668afd546a79924cb80.css integrity="sha256-scTmoQvbqwHzP/+deIFu5oz5qacx8HZor9VGp5kky4A=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/solid.min.423dee17c62f55fa733a4ee13e00d523dfce88cc4f4ab4549a24ba36bd9de681.css integrity="sha256-Qj3uF8YvVfpzOk7hPgDVI9/OiMxPSrRUmiS6Nr2d5oE=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/brands.min.b7d54133b27e5b4de15245b8e143de3e8ed2d674c706137274cedc9953f31917.css integrity="sha256-t9VBM7J+W03hUkW44UPePo7S1nTHBhNydM7cmVPzGRc=" crossorigin=anonymous type=text/css><link rel="shortcut icon" href=/favicons/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicons/favicon-16x16.png><link rel=canonical href=https://rodneyosodo.com/blogs/@rodneyosodo/minimizing-python-docker-images-cf99f4468d39/><script type=text/javascript src=/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js integrity="sha256-+RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/anatole-theme-switcher.min.738c0e3a493854876aeab9e2316fd43f1936aeeac4cc6b3e60bb26456dba72ad.js integrity="sha256-c4wOOkk4VIdq6rniMW/UPxk2rurEzGs+YLsmRW26cq0=" crossorigin=anonymous></script><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rodneyosodo.com/images/site-feature-image.png"><meta name=twitter:title content="Minimizing python docker images"><meta name=twitter:description content="During the transition to a micro service based approach at Qualislabs I saw new faces joining my team. There was definitely a learning‚Ä¶"><meta property="og:title" content="Minimizing python docker images"><meta property="og:description" content="During the transition to a micro service based approach at Qualislabs I saw new faces joining my team. There was definitely a learning‚Ä¶"><meta property="og:type" content="article"><meta property="og:url" content="https://rodneyosodo.com/blogs/@rodneyosodo/minimizing-python-docker-images-cf99f4468d39/"><meta property="og:image" content="https://rodneyosodo.com/images/site-feature-image.png"><meta property="article:section" content="blogs"><meta property="article:published_time" content="2020-03-13T19:12:16+00:00"><meta property="article:modified_time" content="2020-03-13T19:12:16+00:00"><meta property="og:site_name" content="Rodney Osodo"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"blogs","name":"Minimizing python docker images","headline":"Minimizing python docker images","alternativeHeadline":"","description":"
      During the transition to a micro service based approach at Qualislabs I saw new faces joining my team. There was definitely a learning‚Ä¶


    ","inLanguage":"en","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/rodneyosodo.com\/blogs\/@rodneyosodo\/minimizing-python-docker-images-cf99f4468d39\/"},"author":{"@type":"Person","name":"Osodo Rodney"},"creator":{"@type":"Person","name":"Osodo Rodney"},"accountablePerson":{"@type":"Person","name":"Osodo Rodney"},"copyrightHolder":{"@type":"Person","name":"Osodo Rodney"},"copyrightYear":"2020","dateCreated":"2020-03-13T19:12:16.48Z","datePublished":"2020-03-13T19:12:16.48Z","dateModified":"2020-03-13T19:12:16.48Z","publisher":{"@type":"Organization","name":"Osodo Rodney","url":"https://rodneyosodo.com","logo":{"@type":"ImageObject","url":"https:\/\/rodneyosodo.com\/favicons\/favicon-32x32.png","width":"32","height":"32"}},"image":["https://rodneyosodo.com/images/site-feature-image.png"],"url":"https:\/\/rodneyosodo.com\/blogs\/@rodneyosodo\/minimizing-python-docker-images-cf99f4468d39\/","wordCount":"1196","genre":[],"keywords":[]}</script></head><body class="body theme--light"><div class=wrapper><aside class=wrapper__sidebar><div class="sidebar
animated fadeInDown"><div class=sidebar__content><div class=sidebar__introduction><img class=sidebar__introduction-profileimage src=/images/profile.png alt="profile picture"><div class=sidebar__introduction-title><a href=/>Rodney Osodo</a></div><div class=sidebar__introduction-description><p>This is Rodney Osodo's website</p></div></div><ul class=sidebar__list><li class=sidebar__list-item><a href=https://www.linkedin.com/in/rodneyosodo rel=me aria-label=Linkedin title=Linkedin><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://github.com/rodneyosodo rel=me aria-label=GitHub title=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://gitlab.com/0x6f736f646f rel=me aria-label=Gitlab title=Gitlab><i class="fab fa-gitlab fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://twitter.com/b1ackd0t rel=me aria-label=Twitter title=Twitter><i class="fab fa-twitter fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://www.instagram.com/rodneyosodo/ rel=me aria-label=Instagram title=Instagram><i class="fab fa-instagram fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://www.tiktok.com/@b1ackd0t rel=me aria-label=TikTok title=TikTok><i class="fab fa-tiktok fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://www.youtube.com/@rodneyosodo rel=me aria-label=Youtube title=Youtube><i class="fab fa-youtube fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://stackoverflow.com/users/9017060/black-dot rel=me aria-label=StackOverflow title=StackOverflow><i class="fab fa-stack-overflow fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://rodneyosodo.medium.com/ rel=me aria-label=Medium title=Medium><i class="fab fa-medium fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://open.spotify.com/show/2MBoVx1mlX0kjHVrooqasf rel=me aria-label=Spotify title=Spotify><i class="fab fa-spotify fa-2x" aria-hidden=true></i></a></li></ul></div><footer class="footer footer__sidebar"><ul class=footer__list><li class=footer__item>&copy;
2020-2023</li><li class=footer__item><a class=link href=/imprint/ title>imprint</a></li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity=sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN crossorigin=anonymous></script>
<script type=text/x-mathjax-config>
      MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script></div></aside><main class=wrapper__main><header class=header><div class="animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span></a><nav class=nav><ul class=nav__list id=navMenu><li class=nav__list-item><a href=/ title>Home</a></li><li class=nav__list-item><a href=/blogs/ title>Blogs</a></li><li class=nav__list-item><a href=/portfolio/ title>Portfolio</a></li><li class=nav__list-item><a href=/publications/ title>Publications</a></li><li class=nav__list-item><a href=/talks/ title>Talks</a></li><li class=nav__list-item><div class=optionswitch><input class=optionswitch__picker type=checkbox id=menuoptionpicker hidden>
<label class=optionswitch__label class=optionswitch__label for=menuoptionpicker>Accomplishments <i class="fa fa-angle-down" aria-hidden=true></i></label><div class=optionswitch__triangle></div><ul class=optionswitch__list><li class=optionswitch__list-item><a href=/awards/ title>Awards</a></li><li class=optionswitch__list-item><a href=/certifications/ title>Certifications</a></li></ul></div></li><li class=nav__list-item><a href=/contact/ title>Contact</a></li></ul><ul class="nav__list nav__list--end"><li class=nav__list-item><div class=themeswitch><a title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></li></ul></nav></div></header><div class="post
animated fadeInDown"><div class=post__content><h1>Minimizing Python Docker Images</h1><p>During the transition to a micro service based approach at Qualislabs I saw new faces joining my team. There was definitely a learning curve involved and generally it reduces the effectiveness of the team. A newcomer should not feel stranded and burdened with a lot to work with.</p><h3 id=dependency-and-environment-hell>Dependency and Environment Hell</h3><p>Originally we had a monolithic application either in python or node and I must say we were able to debug and fix issues easily even on each others machine. However as our number increased, the number of differing environments became an issue which meant that every machine had to have the correct dependencies and environment.</p><h3 id=12-factor-applications>12 Factor Applications</h3><p>If you have worked on making applications cloud friendly then you may have encountered the <a href=https://12factor.net/>12 factors</a>. We were trying to ensure that every service within our application adhered to all of these factors in order to easily scale and deploy our services with very little to no manual effort.</p><h3 id=the-issue>The Issue</h3><p>Setting appropriate dependencies and environment variables for all members was becoming a bit of a burden and there were times when tests were run against production resources. This was due to developers forgetting to set environment variables back to development values.</p><h3 id=docker-to-ourrescue>Docker to our¬†rescue</h3><p>I later found out about docker. I must admit it felt like love at first sight. With containerization we were able to overcome most of the challenges we had but still missed our former days of monoliths. Developers now only had to build their code with a well documented README file then I would later do the system integration on Friday evening. This was hard since my friends had a better plan for me that evening but I have stayed faithful to docker. We have had our ups and downs but we still care for each other üòÅ. We later converted our apps to micro services written in different languages from the wrath C to the lovely python and Go.</p><h3 id=minimizing-images>Minimizing images</h3><p>So this is what led me to write this. Most of the developers starting out follow what every Indian guy tells them on YouTube like a Church mass. But they encounter many problems which they don‚Äôt know how to solve. One of these problems is when you have large images you have a slower run time and also it takes a lot of time to build and test to production. Large images may hog your memory if you write simple apps with a base image of Ubuntu or Debian yet it would have been better to convert the system to a monolith and they would have shared the requirements.</p><h3 id=101>101</h3><p><strong>Docker</strong> is a set of platforms as a service products that uses OS-level virtualization to deliver software in packages called containers.</p><p><strong>Docker image</strong> is a template to create docker container. It is built using Dockerfile and can be shared to others through a repository.</p><p><strong>Dockerfile</strong> is a set of instructions to build an image. It starts from base image and every instruction creates a layer which is cached for future builds.</p><p><strong>Docker container</strong> is created from docker images. We add a writable layer to it and the allocated resources.</p><p><strong>Registry</strong> is where we store docker images remotely.</p><p>Lets create a python Flask app for demonstration purposes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>from flask import Flask
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>app = Flask(__name__)
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>@app.route(&#34;/&#34;)def hello_world():    return &#34;Hello world from container&#34;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>if __name__ == &#34;__main__&#34;:    app.run(host=&#34;0.0.0.0&#34;, port=5000)
</span></span></code></pre></div><p>We create a virtualenv as we used to do in the monolith days to track our dependencies.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>virtualenv venv --python=python3
</span></span></code></pre></div><p>We activate the virtual environment.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>source venv/bin/activate
</span></span></code></pre></div><p>We install flask in order to run our web application.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pip3 install flask
</span></span></code></pre></div><p>We finally write the dependencies to a requirements file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>pip freeze &gt; requirements.txt
</span></span></code></pre></div><p>The requirements consist of¬†:</p><p><code>click==7.1.1 Flask==1.1.1 itsdangerous==1.1.0 Jinja2==2.11.1 MarkupSafe==1.1.1 Werkzeug==1.0.0</code></p><p>We write a first Dockerfile:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>FROM ubuntuLABEL Maintainer=&#34;Rodney Osodo&#34;WORKDIR /appRUN apt-get update   RUN apt-get install python3-pipCOPY . /appRUN pip3 install -r requirements.txt  WORKDIR EXPOSE 5000CMD [&#39;python3&#39;,&#39;app.py&#39;]
</span></span></code></pre></div><p>and finally build the images,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>docker build -t flask_test:1.0.0 .
</span></span></code></pre></div><p>Our docker images size is 1.28GB, which isn‚Äôt that bad but is extremely bad. üòÇ</p><h3 id=build-process>Build process</h3><p>Lets make another dockerfile from python as the base image:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>FROM pythonWORKDIR /appCOPY . .RUN pip install -r requirements.txtCMD [&#34;python&#34;, &#34;app.py&#34;]
</span></span></code></pre></div><p>Our image size has now reduces to 1GB. Isn‚Äôt that great?</p><p><strong>Optimization objectives</strong></p><ol><li>Reduce image size</li><li>Reduce build time</li></ol><p><strong>Priorities</strong></p><ol><li>Fast builds during development</li><li>Smaller image for production</li></ol><p>Base image</p><p><img src=/images/blogimages/1__CD__enEiEW3lhSXKsgT1Pcw.png alt></p><p>Use slim-stretch as base when you care about build time.<br>Use alpine as base when you care about image size.</p><p>Lets try reducing the images. Ahh we should all be happy now, right?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>FROM python:3.7-slimWORKDIR /appCOPY . .RUN pip install -r requirements.txtCMD [&#34;python&#34;, &#34;app.py&#34;]
</span></span></code></pre></div><p>Image size is 209MB</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>FROM python:3.7-slim-stretchWORKDIR /appCOPY . .RUN pip install -r requirements.txtCMD [&#34;python&#34;, &#34;app.py&#34;]
</span></span></code></pre></div><p>Image size is 186MB</p><p>Definitely slim-stretch is better than slim.<br>What about our alpine base image?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>FROM python:3.7-alpineWORKDIR /appCOPY . .RUN pip install -r requirements.txtCMD [&#34;python&#34;, &#34;app.py&#34;]
</span></span></code></pre></div><p>The image size is 127MB</p><p>First take home is that build dependancies are not needed and only include the necessary files, not all your project files. Unfortunately we had only three files. When copying use dockerignore to exclude files that are not needed.</p><p><strong>Tips</strong></p><ol><li>Combine multiple RUN statements into a single one then delete them in the same layer.</li><li>To benefit from caching arrange statements in ascending order depending on system level dependencies.</li><li>Do not save dependencies<br>- pip3‚Ää‚Äî‚Ääno-cache-dir<br>- apk‚Ää‚Äî‚Ääno-cache</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>FROM python:3.7-alpineWORKDIR /appCOPY . .RUN pip3 install --no-cache-dir -r requirements.txt
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>CMD [&#34;python&#34;, &#34;app.py&#34;]
</span></span></code></pre></div><p>Size 107MB</p><p><strong>Docker multi stage</strong></p><ul><li>Build a docker image with all your deps then install your app.</li><li>Copy the result to a fresh image and label is as the final image.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># Stage 1 - Install build dependenciesFROM python:3.7-alpine AS builderWORKDIR /appRUN python -m venv .venv &amp;&amp; .venv/bin/pip install --no-cache-dir -U pip setuptoolsCOPY requirements.txt .RUN .venv/bin/pip install --no-cache-dir -r requirements.txt &amp;&amp; find /app/.venv ( -type d -a -name test -o -name tests \) -o \( -type f -a -name &#39;*.pyc&#39; -o -name &#39;*.pyo&#39; \) -exec rm -rf &#39;{}&#39; \+
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># Stage 2 - Copy only necessary files to the runner stageFROM python:3.7-alpineWORKDIR /appCOPY --from=builder /app /appCOPY app.py .ENV PATH=&#34;/app/.venv/bin:$PATH&#34;CMD [&#34;python&#34;, &#34;app.py&#34;]
</span></span></code></pre></div><p>Results a smaller image with no build deps.</p><p>Bind mount source code instead of COPY in local dev environment.</p><h3 id=our-benchmark>Our benchmark</h3><p>Our benchmark app was a go app with the same functionality.<br>The beauty of using a compiled code is that it runs faster than interpreted code. The compiled program was checked for errors during compilation.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nf>mainimport</span> <span class=p>(</span>    <span class=s>&#34;fmt&#34;</span>    <span class=s>&#34;net/http&#34;</span><span class=p>)</span><span class=kd>func</span> <span class=nf>main</span><span class=p>(){</span>    <span class=nx>http</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>){</span>        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span>   <span class=s>&#34;Hello from conatiner&#34;</span><span class=p>)</span>    <span class=p>})</span>    <span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:5000&#34;</span><span class=p>,</span>   <span class=kc>nil</span><span class=p>)}</span>
</span></span></code></pre></div><p>We compile the program then it will generated an executable file which we can ran from a scratch image:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>FROM scratchCOPY app /CMD [&#34;/app&#34;]
</span></span></code></pre></div><p>This results to an image size of 25Mb.</p><p>Hopefully you found this story both entertaining and enlightening! I‚Äôm hoping this helped to highlight the benefits of minimising docker images and how you could utilize it for everyday applications to improve developer workflow.</p><p>If you found this useful then please let me know in the comments section or by tweeting me @<a href=https://twitter.com/b1ackd0t>b1ackd0t</a>. I‚Äôd be more than happy to hear any feedback!</p></div><div class=post__footer></div></div></main></div><footer class="footer footer__base"><ul class=footer__list><li class=footer__item>&copy;
2020-2023</li><li class=footer__item><a class=link href=/imprint/ title>imprint</a></li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.1248fa75275e5ef0cbef27e8c1e27dc507c445ae3a2c7d2ed0be0809555dac64.js integrity="sha256-Ekj6dSdeXvDL7yfoweJ9xQfERa46LH0u0L4ICVVdrGQ=" crossorigin=anonymous></script><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity=sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN crossorigin=anonymous></script>
<script type=text/x-mathjax-config>
      MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script></body></html>